require('dotenv').config();
const express = require('express');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const SYSTEM_PROMPT = require('./systemPrompt');

const app = express();

// --- THE NUCLEAR CORS FIX ---
// This manually tells the browser "Yes, Shopify is allowed"
app.use((req, res, next) => {
  res.header("Access-Control-Allow-Origin", "*"); // Allow ANY site
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Access-Control-Allow-Headers", "Content-Type");

  // If the browser checks "Are you there?", say YES immediately
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  next();
});

app.use(express.json());

// Main Route
app.post('/diagnostic', async (req, res) => {
  try {
    // 1. Check API Key
    if (!process.env.GEMINI_API_KEY) {
      console.error("Missing API Key");
      return res.status(500).json({ error: "Server Error: Missing API Key" });
    }

    // 2. Setup AI
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // 3. Build Prompt
    const { history } = req.body;
    const conversation = history ? history.map(turn => `${turn.role}: ${turn.text}`).join('\n') : "";
    
    const prompt = `
      ${SYSTEM_PROMPT}
      CURRENT CONVERSATION:
      ${conversation}
      YOUR RESPONSE (JSON ONLY):
    `;

    // 4. Get Response
    const result = await model.generateContent(prompt);
    const text = result.response.text();
    
    // 5. Clean & Send
    const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
    res.json(JSON.parse(cleanJson));

  } catch (error) {
    console.error("Server Error:", error);
    // Fallback response so site doesn't crash
    res.json({
      type: "question",
      text: "The local line is a bit fuzzy. Could you try asking that again?",
      options: ["Try Again"]
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
