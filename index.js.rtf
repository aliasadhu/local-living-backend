require('dotenv').config();
const express = require('express');
const cors = require('cors'); // Using the library
const { GoogleGenerativeAI } = require('@google/generative-ai');
const SYSTEM_PROMPT = require('./systemPrompt');

const app = express();

// --- THE OFFICIAL CORS FIX ---
// This enables the "Preflight" check automatically
app.use(cors()); 
app.options('*', cors()); // Allow OPTIONS requests for all routes

app.use(express.json());

app.get('/', (req, res) => res.send('Backend is Online'));

app.post('/diagnostic', async (req, res) => {
  try {
    // Check API Key
    if (!process.env.GEMINI_API_KEY) {
      return res.status(500).json({ error: "Missing API Key" });
    }

    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    const { history } = req.body;
    const conversation = history ? history.map(turn => `${turn.role}: ${turn.text}`).join('\n') : "";

    const prompt = `
      ${SYSTEM_PROMPT}
      CURRENT CONVERSATION:
      ${conversation}
      YOUR RESPONSE (JSON ONLY):
    `;

    const result = await model.generateContent(prompt);
    const text = result.response.text();
    const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
    
    res.json(JSON.parse(cleanJson));

  } catch (error) {
    console.error(error);
    // Fallback response to prevent crash
    res.json({
      type: "question",
      text: "I am reconnecting to the island network. Could you ask that again?",
      options: ["Try Again"]
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
